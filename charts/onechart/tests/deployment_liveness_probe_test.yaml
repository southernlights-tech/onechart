suite: test deployment
templates:
  - deployment.yaml
  - configmap.yaml
tests:
  - it: Should set a liveness probe
    set:
      livenessProbe:
        enabled: true
        type: "http"
    asserts:
      - template: deployment.yaml
        documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            httpGet:
              path: "/"
              port: 80
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 3
            failureThreshold: 3
  - it: Should not set a livenessProbe
    asserts:
      - template: deployment.yaml
        documentIndex: 0
        isNull:
          path: spec.template.spec.containers[0].livenessProbe
  - it: Should tune liveness probe
    set:
      livenessProbe:
        enabled: true
        type: "http"
        settings:
          periodSeconds: 30
    asserts:
      - template: deployment.yaml
        documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            httpGet:
              path: "/"
              port: 80
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 3
            failureThreshold: 3
  - it: Should set an exec liveness probe
    set:
      livenessProbe:
        enabled: true
        type: "exec"
        command: ["sh", "-c", "ps aux | grep nginx"]
    asserts:
      - template: deployment.yaml
        documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            exec:
              command:
                - "sh"
                - "-c"
                - "ps aux | grep nginx"
            initialDelaySeconds: 0
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 3
            failureThreshold: 3
  - it: Should tune exec liveness probe
    set:
      livenessProbe:
        enabled: true
        type: "exec"
        command: ["test", "-f", "/tmp/healthy"]
        settings:
          periodSeconds: 15
          timeoutSeconds: 5
    asserts:
      - template: deployment.yaml
        documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            exec:
              command:
                - "test"
                - "-f"
                - "/tmp/healthy"
            initialDelaySeconds: 0
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
            failureThreshold: 3
